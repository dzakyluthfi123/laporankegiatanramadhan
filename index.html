<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Kegiatan Ramadhan - MI MIFTAKHUL ATHFAL</title>
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <!-- html2pdf bundle (versi stabil) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- html2canvas sebagai fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- jspdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .islamic-pattern {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 30L30 60L0 30L30 0z' fill='none' stroke='%23ffffff' stroke-width='0.5' opacity='0.1'/%3E%3C/svg%3E");
    }
    .btn-option {
      transition: all 0.3s ease;
      border-width: 2px;
    }
    .btn-option.active {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .btn-sj {
      border-color: #10b981;
      color: #10b981;
    }
    .btn-sj.active {
      background-color: #10b981;
      color: white;
    }
    .btn-ss {
      border-color: #f59e0b;
      color: #f59e0b;
    }
    .btn-ss.active {
      background-color: #f59e0b;
      color: white;
    }
    .btn-ts {
      border-color: #ef4444;
      color: #ef4444;
    }
    .btn-ts.active {
      background-color: #ef4444;
      color: white;
    }
    .btn-yn {
      transition: all 0.3s ease;
      border-width: 2px;
    }
    .btn-yn.active {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .btn-ya {
      border-color: #10b981;
      color: #10b981;
    }
    .btn-ya.active {
      background-color: #10b981;
      color: white;
    }
    .btn-tidak {
      border-color: #ef4444;
      color: #ef4444;
    }
    .btn-tidak.active {
      background-color: #ef4444;
      color: white;
    }
    .canvas-container {
      border: 2px solid #ddd;
      border-radius: 12px;
      background: white;
      cursor: crosshair;
      display: inline-block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    @keyframes crescentGlow {
      0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3)); }
      50% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6)); }
    }
    @keyframes lanternSwing {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(3deg); }
      75% { transform: rotate(-3deg); }
    }
    .moon-float {
      animation: float 6s ease-in-out infinite;
    }
    .crescent-glow {
      animation: crescentGlow 4s ease-in-out infinite;
    }
    .lantern-swing {
      animation: lanternSwing 5s ease-in-out infinite;
    }
    /* header elegan ramadhan tanpa bintang */
    .ramadhan-header {
      background: linear-gradient(135deg, #0a3b2e 0%, #065f46 40%, #b45309 100%);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
      border-bottom: 3px solid #fbbf24;
    }
    .ramadhan-header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 30%, rgba(251, 191, 36, 0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.15) 0%, transparent 50%);
      pointer-events: none;
    }
    /* pola geometris islami (tanpa bintang) */
    .islamic-border {
      background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 10px, transparent 10px, transparent 20px);
    }
    /* jarak konten agar tidak ketutupan header */
    .main-content {
      margin-top: 180px;
    }
    @media (min-width: 768px) {
      .main-content {
        margin-top: 160px;
      }
    }
    /* header lebih tinggi sedikit agar elemen dekoratif muat */
    header {
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }
    
    /* Fix untuk gambar tadarus agar tidak terpotong di PDF */
    .tadarus-image-container {
      max-width: 100%;
      overflow: hidden;
      border-radius: 12px;
      border: 2px solid #10b981;
      background-color: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      margin: 10px 0;
    }
    .tadarus-image-container img {
      max-width: 100%;
      max-height: 250px;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
    }
    /* Memastikan preview PDF memiliki lebar yang cukup */
    #preview-content {
      width: 100%;
      overflow-x: auto;
      background: white;
    }
    #preview-content .report-container {
      max-width: 210mm;
      margin: 0 auto;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    /* Style untuk preview */
    .preview-header {
      background: linear-gradient(135deg, #065f46, #047857);
      color: white;
    }
    /* Signature container */
    .signature-box {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
    }
    .signature-box img {
      max-width: 100%;
      max-height: 80px;
      object-fit: contain;
    }
    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="h-full">
  <div id="app" class="h-full w-full overflow-auto islamic-pattern" style="background: linear-gradient(135deg, #064e3b 0%, #047857 50%, #059669 100%); font-family: 'Quicksand', sans-serif;">
    
    <!-- HEADER ELEGAN RAMADHAN TANPA BINTANG -->
    <header class="ramadhan-header fixed top-0 left-0 right-0 z-50 py-3 shadow-2xl">
      <!-- Pola geometris islami di background -->
      <div class="absolute inset-0 islamic-border"></div>
      
      <!-- Elemen dekoratif ramadhan: bulan sabit, lentera, masjid (tanpa bintang) -->
      <div class="absolute top-1 left-4 text-5xl opacity-30 moon-float">ğŸŒ™</div>
      <div class="absolute bottom-1 right-8 text-4xl opacity-30 lantern-swing">ğŸ®</div>
      <div class="absolute top-2 right-20 text-3xl opacity-20">ğŸ•Œ</div>
      <div class="absolute bottom-2 left-20 text-4xl opacity-20">â˜ªï¸</div>
      <div class="absolute top-1/2 left-1/3 text-2xl opacity-10">ğŸ•‹</div>
      
      <!-- Ornamen masjid di background -->
      <svg class="absolute left-1/4 top-0 opacity-5" width="120" height="50" viewBox="0 0 120 50">
        <path d="M20,50 L30,20 L40,50 M50,50 L60,20 L70,50 M80,50 L90,20 L100,50" stroke="#fbbf24" fill="none" stroke-width="2"/>
        <circle cx="60" cy="10" r="5" stroke="#fbbf24" fill="none" stroke-width="1.5"/>
      </svg>
      
      <div class="relative z-10 px-4 max-w-6xl mx-auto">
        <!-- Baris pertama: Logo & identitas dengan nuansa ramadhan -->
        <div class="flex items-center justify-between flex-wrap gap-2">
          <!-- Logo dengan efek kilau bulan sabit -->
          <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-amber-500 to-yellow-600 p-3 rounded-2xl shadow-xl transform hover:scale-105 transition-transform duration-300 crescent-glow">
              <div class="text-white font-black text-xl md:text-2xl" style="font-family: 'Amiri', serif;">
                <span class="text-amber-200">MI MIFTAKHUL ATHFAL</span><br>
                <!-- <span class="text-lg">ARROHMAN</span> -->
              </div>
            </div>
            
            <!-- Garis vertikal dekoratif -->
            <div class="hidden md:block h-12 w-0.5 bg-gradient-to-b from-amber-300 to-emerald-300"></div>
            
            <!-- Nama madrasah dengan gaya elegan -->
            <div class="hidden md:block">
              <h1 class="text-white text-xl font-bold" style="font-family: 'Amiri';">MI MIFTAKHUL ATHFAL</h1>
              <p class="text-emerald-200 text-xs flex items-center gap-1">
                <span>ğŸ“</span> Jl.perkutut no 37, Tembok Kidul, Kec. Adiwerna
              </p>
            </div>
          </div>
          
          <!-- Badge Ramadhan mewah dengan bulan sabit -->
          <div class="relative group">
            <div class="absolute inset-0 bg-amber-400/30 rounded-full blur-xl group-hover:bg-amber-400/50 transition-all"></div>
            <div class="relative bg-gradient-to-r from-amber-600 to-yellow-500 text-white px-4 py-2 rounded-full border-2 border-amber-200 shadow-xl flex items-center gap-2">
              <span class="text-2xl animate-pulse">ğŸŒ™</span>
              <div class="text-right">
                <p class="text-xs font-light">RAMADHAN</p>
                <p class="text-sm font-black tracking-wider">1447 H</p>
              </div>
              <span class="text-2xl animate-pulse ml-1">â˜ªï¸</span>
            </div>
          </div>
        </div>
        
        <!-- Divider dekoratif dengan bulan sabit (tanpa bintang) -->
        <div class="flex items-center justify-center gap-2 my-2">
          <div class="h-px w-16 bg-gradient-to-r from-transparent via-amber-300 to-transparent"></div>
          <span class="text-amber-300 text-xl moon-float">ğŸŒ™</span>
          <div class="h-px w-16 bg-gradient-to-l from-transparent via-amber-300 to-transparent"></div>
        </div>
        
        <!-- Judul dan subtitle dengan gaya modern -->
        <div class="text-center">
          <h2 id="main-title" class="text-white text-xl md:text-2xl font-black tracking-wide drop-shadow-lg" style="font-family: 'Amiri'; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
            ğŸ“‹ LAPORAN KEGIATAN RAMADHAN 1447 H / 2026 M
          </h2>
          <p id="subtitle" class="text-amber-200 text-sm md:text-base font-semibold flex items-center justify-center gap-2 mt-1">
            <span>âœ¨</span> Catat Ibadahmu Setiap Hari <span>âœ¨</span>
          </p>
          <!-- Tambahan elemen lentera kecil -->
          <div class="flex justify-center gap-4 mt-1 text-xs text-emerald-200">
            <span class="flex items-center gap-1"><span class="text-amber-300">ğŸŸ¢</span> SJ: Jamaah</span>
            <span class="flex items-center gap-1"><span class="text-amber-300">ğŸŸ¡</span> SS: Sendiri</span>
            <span class="flex items-center gap-1"><span class="text-amber-300">ğŸ”´</span> TS: Tidak</span>
          </div>
          <!-- Tambahan ornamen ketupat kecil -->
          <div class="flex justify-center gap-3 mt-1 text-emerald-300 text-xs">
            <span>ğŸ¥Ÿ</span> <span>ğŸŒ™</span> <span>ğŸ•Œ</span> <span>ğŸ¥Ÿ</span>
          </div>
        </div>
      </div>
    </header>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <!-- Konten dengan jarak aman dari header (tidak ketutupan) -->
    <main class="max-w-4xl mx-auto px-4 py-4 main-content">
      
      <!-- A. Data Siswa -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in">
        <h2 class="text-2xl font-bold text-emerald-800 mb-6 flex items-center gap-2">
          <span>ğŸ‘¤</span> Data Siswa
        </h2>
        
        <form id="student-form" class="space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="block text-emerald-700 font-semibold mb-2">ğŸ“ Nama Lengkap</label>
              <input type="text" id="input-nama" required
                class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" placeholder="Masukkan nama lengkap">
            </div>
            <div>
              <label class="block text-emerald-700 font-semibold mb-2">ğŸ“… Tanggal</label>
              <input type="date" id="input-tanggal" required
                class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50">
            </div>
            <div>
              <label class="block text-emerald-700 font-semibold mb-2">ğŸ« Kelas</label>
              <select id="input-kelas" required
                class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50">
                <option value="">-- Pilih Kelas --</option>
                <option value="Kelas 1a">Kelas 1a</option>
                <option value="Kelas 1b">Kelas 1b</option>
                <option value="Kelas 2a">Kelas 2a</option>
                <option value="Kelas 2b">Kelas 2b</option>
                <option value="Kelas 3a">Kelas 3a</option>
                <option value="Kelas 3b">Kelas 3b</option>
                <option value="Kelas 4a">Kelas 4a</option>
                <option value="Kelas 4b">Kelas 4b</option>
                <option value="Kelas 5a">Kelas 5a</option>
                <option value="Kelas 5b">Kelas 5b</option>
                <option value="Kelas 6a">Kelas 6a</option>
              </select>
            </div>
            <div>
              <label class="block text-emerald-700 font-semibold mb-2">ğŸŒ™ Ramadhan Ke</label>
              <input type="number" id="input-ramadhan" required min="1" max="30"
                class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" placeholder="Masukkan hari ke-">
            </div>
          </div>
        </form>
      </section>

      <!-- B. Laporan Sholat Wajib & Tarawih -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in" style="animation-delay: 0.1s;">
        <h2 class="text-2xl font-bold text-emerald-800 mb-6 flex items-center gap-2">
          <span>ğŸ•Œ</span> Laporan Sholat Wajib & Tarawih
        </h2>

        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
          <p class="text-sm text-blue-800">
            <strong>Keterangan:</strong> 
            <span class="block mt-1">ğŸŸ¢ SJ = Sholat Jamaah | ğŸŸ¡ SS = Sholat Sendiri | ğŸ”´ TS = Tidak Sholat</span>
          </p>
        </div>

        <!-- Subuh -->
        <div class="mb-5 pb-5 border-b border-gray-200">
          <label class="block text-emerald-700 font-semibold mb-3">ğŸŒ… Subuh</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="subuh" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="subuh" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="subuh" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
        <!-- Dzuhur -->
        <div class="mb-5 pb-5 border-b border-gray-200">
          <label class="block text-emerald-700 font-semibold mb-3">â˜€ï¸ Dzuhur</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="dzuhur" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="dzuhur" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="dzuhur" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
        <!-- Ashar -->
        <div class="mb-5 pb-5 border-b border-gray-200">
          <label class="block text-emerald-700 font-semibold mb-3">ğŸŒ¤ï¸ Ashar</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="ashar" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="ashar" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="ashar" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
        <!-- Maghrib -->
        <div class="mb-5 pb-5 border-b border-gray-200">
          <label class="block text-emerald-700 font-semibold mb-3">ğŸŒ… Maghrib</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="maghrib" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="maghrib" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="maghrib" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
        <!-- Isya -->
        <div class="mb-5 pb-5 border-b border-gray-200">
          <label class="block text-emerald-700 font-semibold mb-3">ğŸŒ™ Isya</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="isya" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="isya" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="isya" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
        <!-- Tarawih -->
        <div class="mb-0">
          <label class="block text-purple-700 font-semibold mb-3">ğŸ•Œ Tarawih</label>
          <div class="flex gap-3 flex-wrap">
            <button type="button" class="btn-option btn-sj sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="tarawih" data-value="SJ">ğŸŸ¢ SJ (Sholat Jamaah)</button>
            <button type="button" class="btn-option btn-ss sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="tarawih" data-value="SS">ğŸŸ¡ SS (Sholat Sendiri)</button>
            <button type="button" class="btn-option btn-ts sholat-btn px-4 py-2 rounded-lg font-semibold" data-sholat="tarawih" data-value="TS">ğŸ”´ TS (Tidak Sholat)</button>
          </div>
        </div>
      </section>

      <!-- C. Makan Sahur & Puasa -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in" style="animation-delay: 0.2s;">
        <h2 class="text-2xl font-bold text-emerald-800 mb-8 flex items-center gap-2">
          <span>ğŸ½ï¸</span> Makan Sahur & Puasa
        </h2>

        <div class="mb-8 pb-8 border-b border-gray-200">
          <p class="text-emerald-700 font-semibold mb-4">ğŸŒ… Apakah kamu makan Sahur hari ini?</p>
          <div class="flex gap-4">
            <button type="button" class="btn-yn btn-ya yn-btn px-6 py-3 rounded-lg font-semibold" data-type="sahur" data-value="true">âœ… Iya</button>
            <button type="button" class="btn-yn btn-tidak yn-btn px-6 py-3 rounded-lg font-semibold" data-type="sahur" data-value="false">âŒ Tidak</button>
          </div>
        </div>

        <div class="mb-0">
          <p class="text-emerald-700 font-semibold mb-4">ğŸŒ™ Apakah kamu Puasa hari ini?</p>
          <div class="flex gap-4">
            <button type="button" class="btn-yn btn-ya yn-btn px-6 py-3 rounded-lg font-semibold" data-type="puasa" data-value="true">âœ… Iya</button>
            <button type="button" class="btn-yn btn-tidak yn-btn px-6 py-3 rounded-lg font-semibold" data-type="puasa" data-value="false">âŒ Tidak</button>
          </div>
        </div>
      </section>

      <!-- D. Tadarus Al-Quran -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in" style="animation-delay: 0.3s;">
        <h2 class="text-2xl font-bold text-emerald-800 mb-8 flex items-center gap-2">
          <span>ğŸ“–</span> Tadarus Al-Quran
        </h2>

        <p class="text-emerald-700 font-semibold mb-4">Apakah hari ini kamu Tadarus Al-Quran?</p>
        <div class="flex gap-4 mb-8">
          <button type="button" class="btn-yn btn-ya yn-btn px-6 py-3 rounded-lg font-semibold" data-type="tadarus_alquran" data-value="true">âœ… Iya</button>
          <button type="button" class="btn-yn btn-tidak yn-btn px-6 py-3 rounded-lg font-semibold" data-type="tadarus_alquran" data-value="false">âŒ Tidak</button>
        </div>

        <!-- Tadarus Details (Hidden by default) -->
        <div id="tadarus-details" class="hidden mt-8 pt-8 border-t-2 border-emerald-200">
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
            <p class="text-sm text-blue-800">
              <strong>ğŸ“ Catat tadarus-mu:</strong> 
              <span class="block mt-1">Tuliskan nama surat, dari ayat berapa sampai ayat berapa yang kamu baca hari ini, dan unggah fotonya!</span>
            </p>
          </div>

          <div class="space-y-5 mb-6">
            <div>
              <label class="block text-emerald-700 font-semibold mb-2">ğŸ“• Nama Surat</label>
              <input type="text" id="input-nama-surat"
                class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" 
                placeholder="Contoh: Surah Al-Fatihah, Surah Al-Baqarah">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label class="block text-emerald-700 font-semibold mb-2">ğŸ“ Dari Ayat</label>
                <input type="number" id="input-dari-ayat" min="1"
                  class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" 
                  placeholder="Ayat awal">
              </div>
              <div>
                <label class="block text-emerald-700 font-semibold mb-2">ğŸ“ Sampai Ayat</label>
                <input type="number" id="input-sampai-ayat" min="1"
                  class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" 
                  placeholder="Ayat akhir">
              </div>
            </div>

            <div>
              <label class="block text-emerald-700 font-semibold mb-3">ğŸ“· Unggah Foto Tadarus</label>
              <div class="border-2 border-dashed border-emerald-300 rounded-xl p-6 bg-emerald-50/30 text-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50/50 transition-all" id="upload-area">
                <input type="file" id="input-foto-tadarus" accept="image/*" class="hidden">
                <div id="upload-preview" class="space-y-3">
                  <div class="text-4xl">ğŸ“¸</div>
                  <p class="text-emerald-700 font-semibold">Klik untuk unggah atau ambil foto</p>
                  <p class="text-sm text-emerald-600">Bukti tadarus Anda</p>
                </div>
              </div>
              <div id="foto-preview" class="hidden mt-4">
                <div class="tadarus-image-container">
                  <img id="preview-img" src="" alt="Preview Tadarus">
                </div>
                <button type="button" id="btn-change-foto" class="w-full mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-semibold">
                  ğŸ”„ Ganti Foto
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- E. Kuliah Subuh & Ashar -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in" style="animation-delay: 0.4s;">
        <h2 class="text-2xl font-bold text-emerald-800 mb-6 flex items-center gap-2">
          <span>ğŸ¤</span> Laporan Kuliah Subuh & Ashar
        </h2>

        <div class="space-y-5">
          <div>
            <label class="block text-emerald-700 font-semibold mb-2">ğŸ‘¨â€ğŸ“ Nama Penceramah</label>
            <input type="text" id="input-penceramah"
              class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" placeholder="Masukkan nama penceramah">
          </div>
          <div>
            <label class="block text-emerald-700 font-semibold mb-2">ğŸ“ Tempat Ceramah</label>
            <input type="text" id="input-tempat"
              class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50" placeholder="Masukkan tempat ceramah">
          </div>
          <div>
            <label class="block text-emerald-700 font-semibold mb-2">ğŸ“ Isi/Ringkasan Ceramah</label>
            <textarea id="input-ringkasan" rows="4"
              class="w-full px-4 py-3 rounded-xl border-2 border-emerald-200 focus:border-emerald-500 focus:outline-none transition-colors bg-emerald-50/50 resize-none" placeholder="Tulis ringkasan ceramah yang kamu dengar..."></textarea>
          </div>
        </div>
      </section>

      <!-- F. Tanda Tangan -->
      <section class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-6 mb-6 fade-in" style="animation-delay: 0.5s;">
        <h2 class="text-2xl font-bold text-emerald-800 mb-6 flex items-center gap-2">
          <span>âœï¸</span> Tanda Tangan
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Orang Tua -->
          <div>
            <label class="block text-emerald-700 font-semibold mb-3">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Tanda Tangan Orang Tua</label>
            <canvas id="canvas-orang-tua" class="canvas-container w-full" width="300" height="150"></canvas>
            <div class="flex gap-2 mt-3">
              <button type="button" id="btn-clear-orang-tua" class="flex-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-semibold">ğŸ—‘ï¸ Hapus</button>
              <button type="button" id="btn-save-orang-tua" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-semibold">âœ“ Simpan</button>
            </div>
          </div>
          <!-- Murid -->
          <div>
            <label class="block text-emerald-700 font-semibold mb-3">ğŸ‘¤ Tanda Tangan Murid</label>
            <canvas id="canvas-murid" class="canvas-container w-full" width="300" height="150"></canvas>
            <div class="flex gap-2 mt-3">
              <button type="button" id="btn-clear-murid" class="flex-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-semibold">ğŸ—‘ï¸ Hapus</button>
              <button type="button" id="btn-save-murid" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-semibold">âœ“ Simpan</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <div class="flex gap-3 mb-8 fade-in flex-wrap" style="animation-delay: 0.6s;">
        <button type="button" id="btn-preview"
          class="flex-1 min-w-max py-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold rounded-xl hover:from-blue-700 hover:to-blue-600 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
          <span>ğŸ‘ï¸</span> Preview
        </button>
        <button type="button" id="btn-download"
          class="flex-1 min-w-max py-4 bg-gradient-to-r from-purple-600 to-purple-500 text-white font-bold rounded-xl hover:from-purple-700 hover:to-purple-600 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
          <span>â¬‡ï¸</span> Unduh PDF
        </button>
      </div>

    </main>

    <!-- Preview Modal -->
    <div id="preview-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-auto">
      <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl max-h-screen overflow-auto">
        <div class="sticky top-0 preview-header text-white p-4 flex justify-between items-center rounded-t-2xl">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <span>ğŸ“‹</span> Preview Laporan Ramadhan
          </h3>
          <button id="btn-close-preview" class="text-2xl leading-none hover:opacity-70 bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button>
        </div>
        <div id="preview-content" class="p-6"></div>
        <div class="sticky bottom-0 bg-gray-100 p-4 flex gap-3 justify-end border-t">
          <button id="btn-close-preview-2" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold transition-all">
            Tutup
          </button>
          <button id="btn-download-from-preview" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold flex items-center gap-2 transition-all">
            <span>â¬‡ï¸</span> Unduh PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p id="loading-message" class="text-emerald-800 font-semibold">Sedang memproses PDF...</p>
        <p class="text-gray-500 text-sm mt-2">Mohon tunggu sebentar</p>
      </div>
    </div>

    <!-- Toast Message -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-full shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
      <span id="toast-message">Tersimpan!</span>
    </div>

  </div>

  <script>
    // Default Configuration
    const defaultConfig = {
      app_title: 'ğŸ“‹ LAPORAN KEGIATAN RAMADHAN 1447 H / 2026 M',
      subtitle: 'Catat Ibadahmu Setiap Hari âœ¨'
    };

    let config = { ...defaultConfig };
    let currentRecordData = null;

    // Canvas Drawing Setup
    let canvases = {};
    let signatures = {
      orang_tua: null,
      murid: null
    };

    // Store selected values
    let selectedSholat = {
      subuh: null,
      dzuhur: null,
      ashar: null,
      maghrib: null,
      isya: null,
      tarawih: null
    };

    let selectedYN = {
      sahur: null,
      puasa: null,
      tadarus_alquran: null
    };

    let currentFotoTadarus = null;

    // Initialize Canvas
    function initCanvas(canvasId, storageKey) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#333';
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      let isDrawing = false;

      const startDrawing = (e) => {
        e.preventDefault();
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
      };

      const draw = (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        ctx.lineTo(x, y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        isDrawing = false;
      };

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch support
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);

      canvases[storageKey] = { canvas, ctx };
    }

    function applyConfig() {
      const title = document.getElementById('main-title');
      const subtitle = document.getElementById('subtitle');
      if (title) title.textContent = config.app_title || defaultConfig.app_title;
      if (subtitle) subtitle.textContent = config.subtitle || defaultConfig.subtitle;
    }

    // Show Toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.classList.remove('translate-y-20', 'opacity-0');
        toast.classList.add('translate-y-0', 'opacity-100');
        
        // Change color for error
        if (isError) {
          toast.classList.remove('bg-emerald-600');
          toast.classList.add('bg-red-600');
        } else {
          toast.classList.remove('bg-red-600');
          toast.classList.add('bg-emerald-600');
        }
        
        setTimeout(() => {
          toast.classList.add('translate-y-20', 'opacity-0');
          toast.classList.remove('translate-y-0', 'opacity-100');
        }, 2500);
      }
    }

    // Show/Hide Loading
    function showLoading(message = 'Sedang memproses PDF...') {
      const modal = document.getElementById('loading-modal');
      const msg = document.getElementById('loading-message');
      if (modal && msg) {
        msg.textContent = message;
        modal.classList.remove('hidden');
      }
    }

    function hideLoading() {
      const modal = document.getElementById('loading-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Format Date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    // Get Sholat Status Icon
    function getSholatIcon(value) {
      if (value === 'SJ') return 'ğŸŸ¢ SJ (Sholat Jamaah)';
      if (value === 'SS') return 'ğŸŸ¡ SS (Sholat Sendiri)';
      if (value === 'TS') return 'ğŸ”´ TS (Tidak Sholat)';
      return 'âšª -';
    }

    // Validate Form
    function validateForm() {
      const nama = document.getElementById('input-nama')?.value.trim();
      const tanggal = document.getElementById('input-tanggal')?.value;
      const kelas = document.getElementById('input-kelas')?.value;
      const ramadhan = document.getElementById('input-ramadhan')?.value;

      if (!nama || !tanggal || !kelas || !ramadhan) {
        showToast('âŒ Isi semua data siswa terlebih dahulu!', true);
        return false;
      }

      const allSholatFilled = Object.values(selectedSholat).every(v => v !== null);
      if (!allSholatFilled) {
        showToast('âŒ Pilih status sholat untuk semua waktu!', true);
        return false;
      }

      const allYNFilled = Object.values(selectedYN).every(v => v !== null);
      if (!allYNFilled) {
        showToast('âŒ Pilih jawaban untuk sahur, puasa, dan tadarus!', true);
        return false;
      }

      if (selectedYN.tadarus_alquran === 'true') {
        const namaSurat = document.getElementById('input-nama-surat')?.value.trim();
        const dariAyat = document.getElementById('input-dari-ayat')?.value;
        const sampaiAyat = document.getElementById('input-sampai-ayat')?.value;

        if (!namaSurat || !dariAyat || !sampaiAyat) {
          showToast('âŒ Isi detail tadarus (surat dan ayat)!', true);
          return false;
        }

        if (!currentFotoTadarus) {
          showToast('âŒ Unggah foto tadarus terlebih dahulu!', true);
          return false;
        }
      }

      if (!signatures.orang_tua || !signatures.murid) {
        showToast('âŒ Tanda tangan orang tua dan murid harus ada!', true);
        return false;
      }

      return true;
    }

    // Generate Report HTML
    function generateReportHTML(record) {
      const tadarusImageHTML = record.foto_tadarus ? 
        `<div class="tadarus-image-container">
          <img src="${record.foto_tadarus}" alt="Foto Tadarus">
        </div>` : '';

      return `
        <div class="report-container" style="font-family: 'Quicksand', sans-serif;">
          <!-- Header -->
          <div class="text-center mb-6 border-b-4 border-emerald-600 pb-4">
            <div class="flex justify-center mb-3">
              <div class="bg-gradient-to-br from-emerald-700 to-emerald-500 p-3 rounded-xl shadow-lg">
                <div class="text-white font-black text-2xl md:text-3xl" style="font-family: 'Amiri', serif;">
                  MI<br>MIFTAKHUL ATHFAL<br><span class="text-lg md:text-xl text-amber-300"></span>
                </div>
              </div>
            </div>
            <h1 class="text-xl font-bold text-emerald-800">MI MIFTAKHUL ATHFAL</h1>
            <p class="text-xs text-gray-600">Jl. Perkutut No 37, Tembok Kidul, Kec. Adiwerna</p>
            <div class="w-12 h-0.5 bg-amber-400 mx-auto my-2"></div>
            <h2 class="text-lg font-bold text-emerald-800">LAPORAN KEGIATAN RAMADHAN 1447H/2026M</h2>
          </div>

          <!-- Data Siswa -->
          <div class="grid grid-cols-2 gap-3 mb-4 text-xs bg-emerald-50 p-3 rounded-lg">
            <div><strong>Nama:</strong> ${record.nama_lengkap}</div>
            <div><strong>Tanggal:</strong> ${formatDate(record.tanggal)}</div>
            <div><strong>Kelas:</strong> ${record.kelas}</div>
            <div><strong>Ramadhan ke-:</strong> ${record.ramadhan_ke}</div>
          </div>

          <!-- Sholat -->
          <div class="mb-4">
            <h3 class="text-sm font-bold text-emerald-800 mb-2 border-b pb-1">ğŸ•Œ LAPORAN SHOLAT 5 WAKTU & TARAWIH</h3>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="p-2 bg-gray-50 rounded"><strong>Subuh:</strong> ${getSholatIcon(record.subuh)}</div>
              <div class="p-2 bg-gray-50 rounded"><strong>Dzuhur:</strong> ${getSholatIcon(record.dzuhur)}</div>
              <div class="p-2 bg-gray-50 rounded"><strong>Ashar:</strong> ${getSholatIcon(record.ashar)}</div>
              <div class="p-2 bg-gray-50 rounded"><strong>Maghrib:</strong> ${getSholatIcon(record.maghrib)}</div>
              <div class="p-2 bg-gray-50 rounded"><strong>Isya:</strong> ${getSholatIcon(record.isya)}</div>
              <div class="p-2 bg-purple-50 rounded"><strong>Tarawih:</strong> ${getSholatIcon(record.tarawih)}</div>
            </div>
          </div>

          <!-- Sahur & Puasa -->
          <div class="mb-4">
            <h3 class="text-sm font-bold text-emerald-800 mb-2 border-b pb-1">ğŸ½ï¸ SAHUR & PUASA</h3>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="p-2 bg-gray-50 rounded"><strong>Makan Sahur:</strong> ${record.makan_sahur ? 'âœ… Iya' : 'âŒ Tidak'}</div>
              <div class="p-2 bg-gray-50 rounded"><strong>Puasa:</strong> ${record.puasa ? 'âœ… Iya' : 'âŒ Tidak'}</div>
            </div>
          </div>

          <!-- Tadarus -->
          <div class="mb-4">
            <h3 class="text-sm font-bold text-emerald-800 mb-2 border-b pb-1">ğŸ“– TADARUS AL-QURAN</h3>
            <div class="text-xs mb-2"><strong>Tadarus:</strong> ${record.tadarus_alquran ? 'âœ… Iya' : 'âŒ Tidak'}</div>
            ${record.tadarus_alquran ? `
              <div class="bg-emerald-50 p-2 rounded-lg text-xs">
                <div><strong>Surat:</strong> ${record.nama_surat_tadarus || '-'}</div>
                <div><strong>Ayat:</strong> ${record.dari_ayat_tadarus || '-'} - ${record.sampai_ayat_tadarus || '-'}</div>
                ${tadarusImageHTML}
              </div>
            ` : ''}
          </div>

          <!-- Kuliah -->
          ${record.nama_penceramah || record.tempat_ceramah ? `
            <div class="mb-4">
              <h3 class="text-sm font-bold text-emerald-800 mb-2 border-b pb-1">ğŸ¤ KULIAH SUBUH & ASHAR</h3>
              <div class="bg-gray-50 p-2 rounded-lg text-xs">
                ${record.nama_penceramah ? `<div><strong>Penceramah:</strong> ${record.nama_penceramah}</div>` : ''}
                ${record.tempat_ceramah ? `<div><strong>Tempat:</strong> ${record.tempat_ceramah}</div>` : ''}
                ${record.isi_ringkasan ? `<div class="mt-1"><strong>Ringkasan:</strong><br>${record.isi_ringkasan}</div>` : ''}
              </div>
            </div>
          ` : ''}

          <!-- Tanda Tangan -->
          <div class="mt-6">
            <h3 class="text-sm font-bold text-emerald-800 mb-3 border-b pb-1">âœï¸ TANDA TANGAN</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div class="signature-box mb-1">
                  ${record.ttd_orang_tua ? `<img src="${record.ttd_orang_tua}" alt="TTD Orang Tua">` : '<span class="text-gray-400 text-xs">-</span>'}
                </div>
                <div class="text-xs">
                  <strong>Orang Tua</strong><br>
                  <span class="text-gray-500">${formatDate(record.tanggal)}</span>
                </div>
              </div>
              <div class="text-center">
                <div class="signature-box mb-1">
                  ${record.ttd_murid ? `<img src="${record.ttd_murid}" alt="TTD Murid">` : '<span class="text-gray-400 text-xs">-</span>'}
                </div>
                <div class="text-xs">
                  <strong>Murid</strong><br>
                  <span class="text-gray-500">${record.nama_lengkap}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Collect Form Data
    function collectFormData() {
      return {
        nama_lengkap: document.getElementById('input-nama')?.value.trim() || '',
        tanggal: document.getElementById('input-tanggal')?.value || '',
        kelas: document.getElementById('input-kelas')?.value || '',
        ramadhan_ke: document.getElementById('input-ramadhan')?.value || '',
        subuh: selectedSholat.subuh,
        dzuhur: selectedSholat.dzuhur,
        ashar: selectedSholat.ashar,
        maghrib: selectedSholat.maghrib,
        isya: selectedSholat.isya,
        tarawih: selectedSholat.tarawih,
        makan_sahur: selectedYN.sahur === 'true',
        puasa: selectedYN.puasa === 'true',
        tadarus_alquran: selectedYN.tadarus_alquran === 'true',
        nama_surat_tadarus: document.getElementById('input-nama-surat')?.value.trim() || '',
        dari_ayat_tadarus: document.getElementById('input-dari-ayat')?.value || '',
        sampai_ayat_tadarus: document.getElementById('input-sampai-ayat')?.value || '',
        foto_tadarus: currentFotoTadarus,
        nama_penceramah: document.getElementById('input-penceramah')?.value.trim() || '',
        tempat_ceramah: document.getElementById('input-tempat')?.value.trim() || '',
        isi_ringkasan: document.getElementById('input-ringkasan')?.value.trim() || '',
        ttd_orang_tua: signatures.orang_tua,
        ttd_murid: signatures.murid
      };
    }

    // Show Preview
    function showPreview() {
      if (!validateForm()) return;

      const previewContent = document.getElementById('preview-content');
      currentRecordData = collectFormData();
      previewContent.innerHTML = generateReportHTML(currentRecordData);
      document.getElementById('preview-modal').classList.remove('hidden');
    }

    // Download PDF
    async function downloadPDF() {
      if (!currentRecordData) {
        // Jika belum preview, coba validasi dulu
        if (!validateForm()) return;
        currentRecordData = collectFormData();
      }

      const element = document.getElementById('preview-content');
      if (!element) return;

      // Set content
      element.innerHTML = generateReportHTML(currentRecordData);
      
      // Tampilkan loading
      showLoading('Sedang membuat PDF...');
      
      try {
        // Opsi PDF
        const opt = {
          margin: [10, 10, 10, 10],
          filename: `Laporan_Ramadhan_${currentRecordData.nama_lengkap}_${currentRecordData.tanggal}.pdf`,
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { 
            scale: 2,
            logging: false,
            useCORS: true,
            allowTaint: false,
            letterRendering: true,
            backgroundColor: '#ffffff'
          },
          jsPDF: { 
            orientation: 'portrait', 
            unit: 'mm', 
            format: 'a4',
            compress: true
          }
        };

        // Generate PDF
        await html2pdf().set(opt).from(element).save();
        
        hideLoading();
        showToast('âœ… PDF berhasil diunduh!');
      } catch (error) {
        console.error('PDF Error:', error);
        hideLoading();
        showToast('âŒ Gagal mengunduh PDF. Coba lagi.', true);
      }
    }

    // Save Canvas Signature
    function saveCanvasSignature(storageKey) {
      const canvas = canvases[storageKey];
      if (canvas) {
        signatures[storageKey] = canvas.canvas.toDataURL('image/png');
        showToast('âœ… Tanda tangan disimpan!');
      }
    }

    // Clear Canvas
    function clearCanvas(storageKey) {
      const canvas = canvases[storageKey];
      if (canvas) {
        canvas.ctx.clearRect(0, 0, canvas.canvas.width, canvas.canvas.height);
        canvas.ctx.fillStyle = '#fff';
        canvas.ctx.fillRect(0, 0, canvas.canvas.width, canvas.canvas.height);
        signatures[storageKey] = null;
        showToast('ğŸ—‘ï¸ Tanda tangan dihapus');
      }
    }

    // Handle Tadarus Toggle
    function handleTadarusToggle(value) {
      const details = document.getElementById('tadarus-details');
      if (details) {
        if (value === 'true') {
          details.classList.remove('hidden');
        } else {
          details.classList.add('hidden');
        }
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set default date
      const dateInput = document.getElementById('input-tanggal');
      if (dateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
      }

      // Initialize canvases
      initCanvas('canvas-orang-tua', 'orang_tua');
      initCanvas('canvas-murid', 'murid');

      // Sholat buttons
      document.querySelectorAll('.sholat-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const sholat = btn.dataset.sholat;
          const value = btn.dataset.value;

          document.querySelectorAll(`.sholat-btn[data-sholat="${sholat}"]`).forEach(b => {
            b.classList.remove('active');
          });

          btn.classList.add('active');
          selectedSholat[sholat] = value;
        });
      });

      // Yes/No buttons
      document.querySelectorAll('.yn-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const type = btn.dataset.type;
          const value = btn.dataset.value;

          document.querySelectorAll(`.yn-btn[data-type="${type}"]`).forEach(b => {
            b.classList.remove('active');
          });

          btn.classList.add('active');
          selectedYN[type] = value;

          if (type === 'tadarus_alquran') {
            handleTadarusToggle(value);
          }
        });
      });

      // Photo upload
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('input-foto-tadarus');

      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              currentFotoTadarus = event.target.result;
              const previewImg = document.getElementById('preview-img');
              if (previewImg) {
                previewImg.src = currentFotoTadarus;
              }
              document.getElementById('upload-preview')?.classList.add('hidden');
              document.getElementById('foto-preview')?.classList.remove('hidden');
              showToast('âœ… Foto berhasil diunggah!');
            };
            reader.readAsDataURL(file);
          }
        });
      }

      document.getElementById('btn-change-foto')?.addEventListener('click', () => {
        fileInput?.click();
      });

      // Canvas buttons
      document.getElementById('btn-clear-orang-tua')?.addEventListener('click', () => clearCanvas('orang_tua'));
      document.getElementById('btn-save-orang-tua')?.addEventListener('click', () => saveCanvasSignature('orang_tua'));
      document.getElementById('btn-clear-murid')?.addEventListener('click', () => clearCanvas('murid'));
      document.getElementById('btn-save-murid')?.addEventListener('click', () => saveCanvasSignature('murid'));

      // Main buttons
      document.getElementById('btn-preview')?.addEventListener('click', showPreview);
      document.getElementById('btn-download')?.addEventListener('click', downloadPDF);

      // Preview modal
      const closePreviewBtns = document.querySelectorAll('#btn-close-preview, #btn-close-preview-2');
      closePreviewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('preview-modal')?.classList.add('hidden');
        });
      });

      document.getElementById('btn-download-from-preview')?.addEventListener('click', downloadPDF);

      applyConfig();
    });
  </script>
</body>
</html>